name: Tests

on:
  pull_request:
    branches:
      - main

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix-json: ${{ steps.save-new-matrix.outputs.json }}
      matrix-size: ${{ steps.save-num-affected.outputs.num }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - run: .github/scripts/identify_affected_packages
      - id: save-new-matrix
        run: |
          content=`jq -c . .github/matrix.json`
          echo "json=$content" >> $GITHUB_OUTPUT
      - id: save-num-affected
        run: |
          num_affected=`jq '.include | length' .github/matrix.json`
          echo "$num_affected packages are affected"
          echo "num=$num_affected" >> $GITHUB_OUTPUT
  
  run-tests:
    if: ${{ needs.setup-matrix.outputs.matrix-size.num }} > 0 # only run if matrix is non-empty
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ${{ fromJson(needs.setup-matrix.outputs.matrix-json) }}
    
    # container: enspyrco/ci-tools:stable
    defaults:
      run:
        working-directory: ./packages/${{ matrix.path }}
    
    steps:
      - uses: actions/checkout@v3

      - run: echo ${{ needs.setup-matrix.outputs.matrix-json }}

      - name: Cache Flutter
        id: cache-flutter
        uses: actions/cache@v3
        with:
          path: ~/_flutter
          key: ${{ runner.os }}-${{ matrix.package }}-${{ hashFiles('.github/flutter_stable_version.txt') }}

      - name: Install Flutter
        if: steps.cache-flutter.outputs.cache-hit != 'true'
        run: |
          cd $HOME
          git clone https://github.com/flutter/flutter.git --depth 1 -b stable _flutter
          cd $GITHUB_WORKSPACE
      
      - name: Put flutter on the path
        run: echo "$HOME/_flutter/bin" >> $GITHUB_PATH

      - run: flutter pub get

      - name: Run build_runner if required
        if: ${{ matrix.source_gen }}
        run: flutter pub run build_runner build
      
      - run: flutter test

  run-tests-result:
    if: ${{ always() }}
    runs-on: ubuntu-latest
    needs: run-tests
    steps:
      - run: |
          result="${{ needs.run-tests.result }}"
          echo $result
          if [[ $result == "success" || $result == "skipped" ]]; then
            exit 0
          else
            exit 1
          fi